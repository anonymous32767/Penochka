<!doctype html>
<html>
<head>
  <title>cache &#8212; Кэш</title>
  <link href="style.css" type="text/css" rel="stylesheet" />
</head>
<body>
<h1>cache &#8212; Кэш</h1>
<p class="abstract">Хранилище страничек, загруженных ajaxом.</p>
<p>Кэш обрабатывает событие <tt>/r/ cache</tt> , где ему передается url странички, которую требуется закэшировать в параметре <tt>href</tt> . В случае если страница уже в кэше посылается событие <tt>cache ok</tt> с DOMом страницы в  параметре <tt>data</tt> . В случае если страницы нет в кэше, кэш сразу посылает  событие <tt>pending@, а потом начинает ее загрузку аяксом. По окончании загрузки опять таки посылается событие @cache ok</tt> c DOMом страницы.</p><p>		 В случае неудачи при загрузке страницы кэш добавляет её url с список плохих (переменная <tt>bad</tt> ) и отсылает событие <tt>fail</tt> с указанием причины. В последствии если запрашиваемая страницы уже содержится в списке плохих. Повторный запрос не делается и сообщение о провале высылается сразу.</p><p>		  Особенностью является обработка страниц, не загруженных по причине   таймаута. В этом случае сообщение <tt>fail</tt> высылается, однако страница в 	  список плохих не добавляется, мало ли, вдруг все таки загрузится.</p>

<p><pre>   var cache = {}
		var bad = {}

   $.on('/r/ cache', function (data) {
      var part = $('<span/>')
      var url = data.href.split('#')[0]
      if (cache[url]) {
         data.data = cache[url]
         return $.to('cache ok', data)
      }
      if (bad[url]) {
         data.wtf = 'Cache error'
         return $.to('fail', data)
      }
      $.to('pending', data)
      part.load(
         url + ' ' + $.ss.cache,
         function (responseText, textStatus, XMLHttpRequest) {
            if (textStatus == 'timeout') {
               data.wtf = textStatus
               return $.to('fail', data)
            }
            if (({success:1,notmodified:1})[textStatus]) {
               cache[url] = part
            } else {
               bad[url] = true
            }
            return $.to('/r/ cache', data)
         })
   })</pre></p>
</body></html>
